<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/color-calendar/dist/bundle.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/color-calendar/dist/css/theme-basic.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/color-calendar/dist/css/theme-glass.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
</head>

<body>
<!-- page-->
    <div data-role="page">
    <!-- header-->
    <!-- MENU HEADER 근남-->
    <!-- 메뉴 오픈 클릭시 전체회색화면-->
    <div id="grayScreen" style="display: none; position: absolute;background-color: #E8E8E8; width: 100%; height: 100%; opacity: 0.5;z-index: 10;"></div>
    <!-- 헤더 -->
    <div data-role="header" id="header" style="height: 4em;width: 100%; overflow: hidden; position: fixed; top: 0px; display: block; background-color: white;">
        <div id="header_backbutton" style="width: 27%; height: 100%; overflow: hidden; position: relative; padding-left: 0.5em;display: inline-block;text-align: left;">
            <a style="vertical-align: middle;" onclick="$.mobile.back();"><img height="25em" src="../Resources/header_Menu_Image/back_img.png"></a>
        </div><div id="header_menu" style="width: 70%; height: 100%; right: 0;overflow: hidden; position: relative; display: inline-block;">
            <button id="showRightMenuOpen" class="ui-btn"alt="menu" onclick="activeNav()" style="padding: 0 0 0 0;position: fixed ;border-style: none; background-color: white;">
                <img src="../Resources/header_Menu_Image/open_menulist.png" id="Menu_Open_img" height="50em">
            </button>
            <script type="text/javascript">
                function activeNav(){ 
                    var m_menu = document.getElementById("menu");
                    var m_grayScreen = document.getElementById("grayScreen");
                    if(m_menu.style.display =='none'){
                        $("#menu").show(200);
                        m_grayScreen.style.display= 'inline-block';
                    }else{
                        $("#menu").hide(200);
                        m_grayScreen.style.display='none';
                    }
                }

                $("#grayScreen").click(function(){
                    var m_menu = document.getElementById("menu");
                    var m_grayScreen = document.getElementById("grayScreen");
                    m_menu.style.display = 'none';
                    m_grayScreen.style.display='none';
                });
            </script>
        </div>
    </div>
    
    <div id="menu" style="height: 100%; background: white ; display: none; position: fixed; float: right; right: 0px; z-index: 100; list-style: none;">
        <div style="display: inline-block; width:100%; height: 4em; margin:  0 0 0 0;text-align: right;">
            <button id="showRightMenuClose" class="ui-btn" alt="menu"  onclick="activeNav()" style="display: inline-block; width: 3.5em;height: 3.5em;padding: 0 0 0 0; border-style: none; background-color: white;">
                <img src="../Resources/header_Menu_Image/close_menulist.png" id="Menu_Close_img" height="50em" style="">
            </button>
        </div>
        
        <ul data-role="none" id="menu-list" style="list-style:none; font-size: 3em ;display: block; position: fixed; top: 13%; text-decoration: none;">
            <li id="page_Notice" >
                <a href="../Notices/Notices.html" rel="external" >NOTICE.</a>
            </li>
            <li id="page_Calendar">
                <a href="../Calendar/calendar.html" rel="external" >CALENDAR.</a>
            </li>
            <li id="page_QA">
                <a href="../Q&As/Q&As.html" rel="external">Q&A.</a>
            </li>
        </ul>
    </div>
    <style> 
        #header_backbutton:after{display:inline-block; height:100%; content:""; vertical-align:middle;}
        #menu-list a{
            color: black;
            text-decoration: none;
        }
        #menu-list a:link{
            color: black;
            text-decoration: none;
        }
        #menu-list a:visited { color: black; text-decoration: none;}
        #menu-list li{ text-align: left; margin-top: 1.3em;  margin-bottom: 1.3em; font-size: 0.5em;}
        #page_Notice:hover{
        background-color: #ACDEE7;
        color: white;
        }
        #page_Calendar:hover{
        background-color: #FFE699;
        color: white;
        }
        #page_QA:hover{
        background-color: #C3D9C2;
        color: white;
        }
        @media (max-width: 1000px) {
            #menu{
                width: 65%
            }
            #header{
                height: 10%;
            }
            #showRightMenuOpen{
                top: 0.5% ;right: 0.5%
            }
            #showRightMenuClose{
                top: 0.5% ;right: 0.5%
            }
        }
        @media (min-width: 1001px) {
            #menu{
                width: 40%
            }
            #header{
                height: 15%;
            }
            #showRightMenuOpen{
                top: 3% ;right: 3%
            }
            #showRightMenuClose{
                top: 3% ;right: 3%
            }
        }
    </style>
    <!-- 여기까지 MENU HEADER 근남-->

        <div style="
        background-color: #F59B5D;
        color: white;
        font-size:30px;
        font-family: url('../Resources/Font/NanumSquareB.ttf');
        text-size-adjust: auto;
        height:4.5em;
        text-align:left;
        vertical-align: bottom;
        padding-top: 3em;
        padding-left:3%;
        ">
            <br><br>
            CALENDAR.<br>
        </div>
    
    
    <!-- end of header.-->

    <!-- contents -->    
        <div data-role="content" style="text-align:center;">
        <!-- 1. CALENDAR-->
            <div id="color-calendar" style="width:100%;"></div>
            <script>
                var isChanging=false;
                let myCal = new Calendar({
                    theme: 'glass',
                    // eventsData: [
                    //     {
                    //         start: '2021-06-11T06:00:00',
                    //         end: '2021-06-11T20:30:00',
                    //         name: '류형주 생일'
                    //     },
                    //     {
                    //         start: '2021-06-11T06:00:00',
                    //         end: '2021-06-11T20:30:00',
                    //         name: '모바일웹프로그래밍 발표'
                    //     },
                    //     {
                    //         start: '2021-06-09T06:00:00',
                    //         end: '2021-06-09T20:30:00',
                    //         name: '로봇비전시스템 기말고사'
                    //     },
                    //     {
                    //         start: '2021-07-16T06:00:00',
                    //         end: '2021-07-16T20:30:00',
                    //         name: '종합설계 최종발표'
                    //     }

                    // ],
                    primaryColor: '#DB3A00',
                    headerColor: '#DB3A00',
                    headerBackgroundColor: '#FFFFFF',
                    weekdaysColor: 'black',
                    fontFamilyHeader: "'Nanum Gothic', sans-serif",
                    fontFamilyWeekdays: "'Nanum Gothic', sans-serif",
                    fontFamilyBody: "'Nanum Gothic', sans-serif",
                    dropShadow: "0 7px 30px -10px rgba(150, 170, 180, 0.5)",
                    disableMonthYearPickers: true
                })
                myCal.monthChanged =function(currentDate, filteredMonthEvents){
                    console.log('month changed fired')
                    ReceiveEventsAndRedraw(currentDate.getFullYear(), currentDate.getMonth())
                }
                var selDate = myCal.getSelectedDate()
                ReceiveEventsAndRedraw(selDate.getFullYear(),selDate.getMonth())
                // 캘린더에 클릭 이벤트 리스너를 붙여준다.
                myCal.calendarDays.addEventListener('click', handleCalendarDayClick);
                myCal.prevButton.addEventListener('click', function empty(){
                    $("#list").empty();
                });
                myCal.nextButton.addEventListener('click', function empty(){
                    $("#list").empty();
                });

                function ReceiveEventsAndRedraw(year, month){
                    if(isChanging)return
                    isChanging=true
                    month=month+1
                    if(month.length == 1){
                        month="0"+month
                    }
                    console.log('start fetch : ' + `https://us-central1-mme-info.cloudfunctions.net/apis-getSchedulesByMonth?year=${year}&month=${month}`);
                    fetch(`https://us-central1-mme-info.cloudfunctions.net/apis-getSchedulesByMonth?year=${year}&month=${month}`)
                    .then((response)=> response.json()).then((datas)=>{
                        console.log('got fetch data : '+datas)
                        var eventDatas=[]
                        datas.forEach(element => {
                            if(element.isenabled!=true){
                                return
                            }
                            var from = new Date(element.start._seconds*1000)
                            var name=element.name
                            var to = new Date(element.end._seconds*1000)
                            eventDatas.push({
                                start:from,
                                end:to,
                                name:name
                            })
                        });
                        myCal.setEventsData(eventDatas)
                        isChanging=false
                    })
                }

                function handleCalendarDayClick(e) {
                    // 예외1 : 다른 부분들을 클릭한 경우
                    if (
                        !(
                            e.target.classList.contains("calendar__day-box") ||
                            e.target.classList.contains("calendar__day-text") ||
                            e.target.classList.contains("calendar__day-box-today") ||
                            e.target.classList.contains("calendar__day-bullet")
                        ) ||
                        e.target.parentElement.classList.contains("calendar__day-selected")
                    ) {
                        return;
                    }

                    // 예외2 : 선택 불가능한 날짜인 경우
                    if (myCal.disableDayClick) {
                        return;
                    }

                    // 예외3 : 선택 중인 날짜를 클릭한 경우
                    if (
                        myCal.oldSelectedNode &&
                        !myCal.oldSelectedNode[0]
                    ) {
                        return;
                    }

                    // 내가 클릭한 날짜와, 이번 달의 이벤트를 가져온다.
                    var date = parseInt(e.target.parentElement.innerText, 10);
                    var events = myCal.filteredEventsThisMonth;
                    var a, b;
                    
                    // 리스트를 비우고, 오늘 날짜에 해당되는 이벤트들을 <li>로 넣어준다.
                    $("#list").empty();
                    for (var i = 0; i < events.length; i++) {
                        a = new Date(events[i]["start"]).getDate();
                        b = new Date(events[i]["end"]).getDate();
                        if (a <= date && date <= b) {
                            output = '<li>' + '<span style="color:red; font-weight:bold;">' + date + '일&nbsp&nbsp&nbsp' + '</span>' + events[i]["name"] + '</li>';
                            $("#list").append(output);
                        }
                    }

                    // jquery 모바일의 list를 업데이트 해준다.
                    $("#list").listview("refresh");
                }
            </script>
        <!-- end of CALENDAR.-->
            
        <!-- 2. AGENDA-->
            <div id="agenda" style="
            justify-content: center;
            font-family: url('../Resources/Font/NanumSquareR.ttf');">
                <ul data-role="listview" id="list" data-inset="inset">
                </ul>
            </div>
        <!-- end of AGENDA. -->

        </div>
    <!-- end of contents.-->

    </div>
<!-- end of page.-->
</body>

</html>